function changeRating(c,d){$.cookies.del(generatePageName());var b=$(c),f=b.siblings(".vote"),e=b.siblings("a").not(".vote"),a=$("#written-feedback");b.fadeOut("slow").delay(250).remove();f.removeClass("vote");postRating("0","change");e.on("click",ratingClick).animate({opacity:1,width:d},{duration:650,queue:false});if(a.is(":visible")){a.slideUp("slow")}}function addChangeRating(d,c,b){var a=$('<a id="change-link" href="#">Change</a>').on("click",function(f){f.preventDefault();changeRating(this,c)});a.delay(500).insertAfter(d).fadeIn("fast",function(){if(b){$("#written-feedback").slideDown()}})}function markRating(c){var b=c.hasClass("downvote"),a=false,d="1";actionType=$("#ratings").attr("data-type");if(b){a=true;d="-1"}c.addClass("vote");otherRatingWidth=c.siblings("a").width();c.siblings("a").off("click").animate({opacity:0,width:0},{duration:650,queue:false,complete:addChangeRating(c,otherRatingWidth,a)});postRating(d,actionType);if(!b){showThanks()}}function showThanks(){$("#pr-thank-you span").fadeIn("slow").delay(2500).fadeOut("slow")}function ratingClick(a){a.preventDefault();ratingLink=$(this);if(!ratingLink.hasClass("vote")){markRating(ratingLink)}}function hideCommentShowThanks(a){$("#written-feedback").slideUp("slow",showThanks)}function writtenSubmit(a){a.preventDefault();if($("#written-feedback textarea").val()!=""){postComment($("#written-feedback textarea").val());hideCommentShowThanks()}}function postRating(e,c){var b="",d="",a="0",h="",f="/app/page-feedback/page-feedback.php";if($('meta[name="revisionNumber"]').length){a=$('meta[name="revisionNumber"]').attr("content");d+=("&pageVersion="+a)}if($('meta[name="lastUpdated"]').length){h=$('meta[name="lastUpdated"]').attr("content");d+="&pageLastUpdate="+h}b="type="+c+"&rating="+e+"&pageURL="+window.location+d;if(c=="insert"){$.ajax({type:"POST",url:f,data:b}).done(function(i){$("#ratings").attr("data-key",i.substring(0,10));createRatingCookie(e,i.substring(0,10),a,h)}).fail(function(i,j){});$("#ratings").attr("data-type","change")}else{var g=$("#ratings").attr("data-key");$.ajax({type:"POST",url:f,data:"type="+c+"&rating="+e+"&pageURL="+window.location+"&userKey="+g}).done(function(){if(e!="0"){createRatingCookie(e,g,a,h)}}).fail(function(i,j){})}}function postComment(c){var b=$("#ratings").attr("data-key"),a="/app/page-feedback/page-feedback.php";$.ajax({type:"POST",url:a,data:"type=comment&pageComment="+c+"&userKey="+b})}function generatePageName(){var b=window.location.pathname,a=b.substring(b.lastIndexOf("/")+1);if(a==""){a=b.split("/");a=a[a.length-2]+"-index"}return a}function createRatingCookie(b,f,a,h){var g=new Date(),e=g.getTime()+((1000*60)*30).toString();var i={rating:b,userKey:f,pageVersion:a,pageLastUpdate:h,expireTime:e};var c={expiresAt:g.setDate(g.getDate()+30)};$.cookies.set(generatePageName(),i,c)}function existingRating(b,a){var c=new Date();time=c.getTime();if(b){ratingLink=$(".upvote")}else{ratingLink=$(".downvote")}if(($('meta[name="revisionNumber"]').attr("content")==a.pageVersion)||(!($('meta[name="revisionNumber"]').length)&&a.pageVersion=="0")){if(time<parseInt(a.expireTime)){ratingLink.addClass("vote");initializePageRating(false);$("#ratings").attr("data-type","change").attr("data-key",a.userKey);otherRatingWidth=ratingLink.siblings("a").width();ratingLink.siblings("a").off("click").animate({opacity:0,width:0},{duration:0,queue:false,complete:addChangeRating(ratingLink,otherRatingWidth,false)});showPageRating()}else{ratingLink.addClass("vote locked").on("click",function(d){d.preventDefault()}).siblings("a").hide();showPageRating()}}else{$.cookies.del(generatePageName());initializePageRating(true)}}function initializePageRating(c){var e=$("#ux-page-rating .upvote"),d=$("#ux-page-rating .downvote"),b=$("#feedBackSubmit"),a=$(".no-comment");e.on("click",ratingClick);d.on("click",ratingClick);b.on("click",writtenSubmit);a.on("click",hideCommentShowThanks);if(c){showPageRating()}}function showPageRating(){$("#ux-page-rating").animate({opacity:1},{duration:2000,queue:false})}$(document).ready(function(){if(location.protocol=="https:"){$("#ux-page-rating").hide()}else{if($("#ux-page-rating")){var a=$.cookies.get(generatePageName()),b=true;if(a){if(a.rating){if(a.rating=="-1"){b=false}existingRating(b,a)}else{initializePageRating(true)}}else{initializePageRating(true)}}}});